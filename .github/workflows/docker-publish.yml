name: Docker

# This workflow uses actions that are not certified by GitHub.
# They are provided by a third-party and are governed by
# separate terms of service, privacy policy, and support
# documentation.

on:
  push:
    # Publish Docker images only for tags ending with -docker
    tags: ["v*.*.*-docker"]
  pull_request:
    branches: ["main"]
  workflow_dispatch:
    inputs:
      version:
        description: "Version to build (e.g., 1.0.0)"
        required: true
        type: string

env:
  # Use docker.io for Docker Hub if empty
  REGISTRY: ghcr.io
  # Use aether-mailer as the image name
  IMAGE_NAME: aether-mailer

jobs:
  build:
    runs-on: ubuntu-latest
    # Only run on tags ending with -docker or on PRs for testing
    if: startsWith(github.ref, 'refs/tags/') && endsWith(github.ref, '-docker') || github.event_name == 'pull_request'
    permissions:
      contents: read
      packages: write
      # This is used to complete the identity challenge
      # with sigstore/fulcio when running outside of PRs.
      id-token: write

    outputs:
      version: ${{ steps.version.outputs.version }}
      package_version: ${{ steps.version.outputs.package_version }}

    steps:
      - name: Print trigger information
        run: |
          echo "Event name: ${{ github.event_name }}"
          echo "Ref: ${{ github.ref }}"
          echo "Ref name: ${{ github.ref_name }}"
          echo "Ref type: ${{ github.ref_type }}"
          echo "Repository: ${{ github.repository }}"
          echo "Workflow: ${{ github.workflow }}"
          echo "Actor: ${{ github.actor }}"
          echo "Is tag: ${{ startsWith(github.ref, 'refs/tags/') }}"
          echo "Ends with -docker: ${{ endsWith(github.ref, '-docker') }}"
          echo "Should run: ${{ startsWith(github.ref, 'refs/tags/') && endsWith(github.ref, '-docker') || github.event_name == 'pull_request' }}"
          echo "Registry: ${{ env.REGISTRY }}"
          echo "Image name: ${{ env.IMAGE_NAME }}"
          echo "Full image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}"

      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Extract version from tag
        id: version
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.version }}"
            PACKAGE_VERSION="${VERSION%-docker}"
          else
            TAG="${{ github.ref_name }}"
            VERSION="${TAG#v}"
            PACKAGE_VERSION="${VERSION%-docker}"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "package_version=$PACKAGE_VERSION" >> $GITHUB_OUTPUT
          echo "Tag version: $VERSION"
          echo "Package version: $PACKAGE_VERSION"

      - name: Verify Dockerfile exists
        run: |
          echo "Checking for Dockerfile..."
          if [ -f "Dockerfile" ]; then
            echo "‚úÖ Dockerfile found at root"
            echo "Dockerfile content preview:"
            head -20 Dockerfile
          else
            echo "‚ùå No Dockerfile found at root"
            echo "Available files:"
            find . -name "Dockerfile" -type f
            exit 1
          fi

      - name: Build cross-platform binaries
        run: |
          echo "üî® Building cross-platform binaries for Aether Mailer..."

          # Create dist directory
          mkdir -p dist

          # Define platforms
          platforms=(
            "linux/amd64"
            "linux/arm64" 
            "windows/amd64"
            "darwin/amd64"
            "darwin/arm64"
          )

          # Build Go server binary
          echo "Building Go server..."
          cd server
          for platform in "${platforms[@]}"; do
            IFS='/' read -r GOOS GOARCH <<< "$platform"
            
            output_name="aether-mailer-server"
            if [ "$GOOS" = "windows" ]; then
              output_name+=".exe"
            fi
            
            echo "Building server for $GOOS/$GOARCH..."
            GOOS=$GOOS GOARCH=$GOARCH go build \
              -ldflags="-s -w -X main.version=${{ steps.version.outputs.package_version }}" \
              -o "../dist/${GOOS}-${GOARCH}-${output_name}" \
              .
          done
          cd ..

          # Build CLI binary (TypeScript)
          echo "Building CLI..."
          cd cli

          # Install CLI dependencies
          npm install

          # Build CLI for all platforms
          npm run build

          # Get the built binary and create platform-specific versions
          BINARY_NAME="mailer"

          for platform in "${platforms[@]}"; do
            IFS='/' read -r GOOS GOARCH <<< "$platform"
            
            # Determine platform-specific extension
            if [ "$GOOS" = "windows" ]; then
              OUTPUT_NAME="${GOOS}-${GOARCH}-${BINARY_NAME}.exe"
            else
              OUTPUT_NAME="${GOOS}-${GOARCH}-${BINARY_NAME}"
            fi
            
            echo "Creating CLI package for $GOOS/$GOARCH..."
            
            # Create platform directory
            mkdir -p "../dist/${GOOS}-${GOARCH}-cli"
            
            # Copy built CLI (Node.js executable)
            if [ -f "dist/main.js" ]; then
              cp dist/main.js "../dist/${GOOS}-${GOARCH}-cli/${BINARY_NAME}.js"
              chmod +x "../dist/${GOOS}-${GOARCH}-cli/${BINARY_NAME}.js"
            fi
            
            # Copy package.json for dependencies
            cp package.json "../dist/${GOOS}-${GOARCH}-cli/"
            
            # Create platform-specific launcher script
            if [ "$GOOS" = "windows" ]; then
              cat > "../dist/${GOOS}-${GOARCH}-cli/${BINARY_NAME}.bat" << 'EOF'
          @echo off
          node "%~dp0${BINARY_NAME}.js" %*
          EOF
            else
              cat > "../dist/${GOOS}-${GOARCH}-cli/${BINARY_NAME}" << 'EOF'
          #!/usr/bin/env node
          DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
          node "$DIR/${BINARY_NAME}.js" "$@"
          EOF
              chmod +x "../dist/${GOOS}-${GOARCH}-cli/${BINARY_NAME}"
            fi
          done
          cd ..

          # Build Next.js frontend (platform-independent)
          echo "Building Next.js frontend..."
          cd app
          pnpm install
          pnpm build

          # Create frontend package
          mkdir -p ../dist/frontend
          cp -r .next/standalone ../dist/frontend/
          cp -r .next/static ../dist/frontend/
          cp package.json ../dist/frontend/
          cd ..

          echo "‚úÖ Cross-platform binaries built successfully!"
          ls -la dist/

      - name: Create platform-specific archives
        run: |
          echo "üì¶ Creating platform-specific archives..."

          VERSION="${{ steps.version.outputs.package_version }}"

          # Create archives for each platform
          platforms=("linux/amd64" "linux/arm64" "windows/amd64" "darwin/amd64" "darwin/arm64")

          for platform in "${platforms[@]}"; do
            IFS='/' read -r GOOS GOARCH <<< "$platform"
            
            # Create archive directory
            archive_dir="aether-mailer-${VERSION}-${GOOS}-${GOARCH}"
            mkdir -p "dist/${archive_dir}"
            
            # Copy binaries
            if [ "$GOOS" = "windows" ]; then
              cp "dist/${GOOS}-${GOARCH}-aether-mailer-server.exe" "dist/${archive_dir}/"
              cp -r "dist/${GOOS}-${GOARCH}-cli" "dist/${archive_dir}/"
            else
              cp "dist/${GOOS}-${GOARCH}-aether-mailer-server" "dist/${archive_dir}/"
              cp -r "dist/${GOOS}-${GOARCH}-cli" "dist/${archive_dir}/"
            fi
            
            # Copy frontend
            cp -r dist/frontend/* "dist/${archive_dir}/"
            
            # Copy configuration files
            cp docker-compose.yml docker-entrypoint.sh "dist/${archive_dir}/" 2>/dev/null || true
            cp -r prisma/ "dist/${archive_dir}/" 2>/dev/null || true
            
          # Create README for the archive
            cat > "dist/${archive_dir}/README.md" << EOF
          # Aether Mailer v${VERSION}

          Platform: ${GOOS}/${GOARCH}

          ## Installation

          1. Extract the archive
          2. Run the server: \`\`\`./aether-mailer-server\`\`\`
          3. Run the CLI: 
             - Linux/macOS: \`\`\`./mailer --help\`\`\`
             - Windows: \`\`\`mailer.bat --help\`\`\` or double-click \`mailer.bat\`

          ## Components

          - **aether-mailer-server**: Main backend server (Go)
          - **mailer/**: Command-line interface (TypeScript/Node.js)
          - **frontend/**: Next.js web application

          ## CLI Requirements

          The CLI requires Node.js to be installed on your system.

          ## Configuration

          See \`prisma/\` directory for database configuration.
          EOF

            # Create the archive
            cd dist
            if [ "$GOOS" = "windows" ]; then
              zip -r "${archive_dir}.zip" "${archive_dir}"
            else
              tar -czf "${archive_dir}.tar.gz" "${archive_dir}"
            fi
            cd ..
            
            # Clean up archive directory
            rm -rf "dist/${archive_dir}"
          done

          echo "‚úÖ Platform archives created!"
          ls -la dist/*.tar.gz dist/*.zip 2>/dev/null || true

      - name: Upload build artifacts
        uses: actions/upload-artifact@v6
        with:
          name: aether-mailer-binaries
          path: |
            dist/*.tar.gz
            dist/*.zip
          retention-days: 30

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@8d2750c68a42422c14e847fe6c8ac0403b4cbd6f # v3.12.0

      # Login against a Docker registry except on PR
      # https://github.com/docker/login-action
      - name: Log into registry ${{ env.REGISTRY }}
        if: github.event_name != 'pull_request'
        uses: docker/login-action@5e57cd118135c172c3672efd75eb46360885c0ef # v3.6.0
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # Extract metadata (tags, labels) for Docker
      # https://github.com/docker/metadata-action
      - name: Extract Docker metadata
        id: meta
        uses: docker/metadata-action@c299e40c65443455700f0fdfc63efafe5b349051 # v5.10.0
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=ref,event=tag,suffix=-docker
            type=raw,value=latest,enable={{is_default_branch}}
          flavor: |
            latest=auto

      # Build and push Docker image with Buildx (don't push on PR)
      # https://github.com/docker/build-push-action
      - name: Build and push Docker image
        id: build-and-push
        uses: docker/build-push-action@64c9b141502b80dbbd71e008a0130ad330f480f8 # v6.18.0
        with:
          context: .
          file: ./Dockerfile
          push: ${{ github.event_name != 'pull_request' }}
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          platforms: linux/amd64,linux/arm64
          cache-from: type=gha
          cache-to: type=gha,mode=max
          provenance: false

      # Sign the resulting Docker image digest except on PRs.
      # This will only write to the public Rekor transparency log when the Docker
      # repository is public to avoid leaking data.  If you would like to publish
      # transparency data even for private images, pass --force to cosign below.
      # https://github.com/sigstore/cosign
      - name: Sign the published Docker image
        if: ${{ github.event_name != 'pull_request' }}
        env:
          # https://docs.github.com/en/actions/security-guides/security-hardening-for-github-actions#using-an-intermediate-environment-variable
          TAGS: ${{ steps.meta.outputs.tags }}
          DIGEST: ${{ steps.build-and-push.outputs.digest }}
        # This step uses the identity token to provision an ephemeral certificate
        # against the sigstore community Fulcio instance.
        run: echo "${TAGS}" | xargs -I {} cosign sign --yes {}@${DIGEST}

  release:
    name: Create GitHub Release
    needs: build
    if: startsWith(github.ref, 'refs/tags/') && endsWith(github.ref, '-docker') && github.event_name != 'pull_request'
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Download artifacts
        uses: actions/download-artifact@v7
        with:
          path: artifacts

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.ref_name }}
          name: Aether Mailer v${{ needs.build.outputs.package_version }}
          body: |
            ## Aether Mailer v${{ needs.build.outputs.package_version }}

            üê≥ **Docker Image**: `${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ needs.build.outputs.version }}`

            üì¶ **Platform Binaries**:
            - Linux (x86_64, ARM64)
            - Windows (x86_64) 
            - macOS (x86_64, ARM64)

            ### üöÄ Quick Start

            #### Docker (Recommended):
            ```bash
            docker run -p 3000:3000 ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ needs.build.outputs.version }}
            ```

            #### Binary:
            Download the appropriate archive for your platform and extract.
            Then run:
            ```bash
            ./aether-mailer-server
            ```

            ### üìã Components

            - **aether-mailer-server**: Main backend server
            - **mailer**: Command-line interface  
            - **frontend**: Next.js web application

            ---

            üêõ **Report Issues**: [GitHub Issues](https://github.com/skygenesisenterprise/aether-mailer/issues)
            üí° **Get Help**: [GitHub Discussions](https://github.com/skygenesisenterprise/aether-mailer/discussions)

            üì¶ **Made with ‚ù§Ô∏è by [Sky Genesis Enterprise](https://skygenesisenterprise.com)**
          draft: false
          prerelease: false
          files: |
            artifacts/**/*.tar.gz
            artifacts/**/*.zip
